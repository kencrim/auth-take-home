<!DOCTYPE html>
<html lang="eng">
<head>
	<meta charset="utf-8" />
	<meta name="google-signin-client_id" content="537521020853-sr6vfmg034hi3cf10sj17q8qu9plbdf2.apps.googleusercontent.com">
	<title>Add Title</title>
	<script src="https://apis.google.com/js/platform.js" async defer></script>
</head>
<body>
	<div class="g-signin2" data-onsuccess="onSignIn"></div>
	<a href="#" onclick="signOut()">Sign out</a>
	<script>
		function onSignIn(googleUser) {
			// Gets auth token from Google User auth object
			let id_token = googleUser.getAuthResponse().id_token;
			authenticateGoogleUser(id_token);
		}

		function signOut() {
			let auth2 = gapi.auth2.getAuthInstance();
			auth2.signOut()
			.then( () => console.log('User signed out.') ); // need to delete cookies here
		};

		function responseParser(res) {
			// Check for error
			if(!res.ok){
				// If user has not been found in the database, sign them back out and throw error
				signOut()
				throw Error(res.statusText);
			} else {
				// Parse response to json
				return res.json();
			}
		}

		function authenticateGoogleUser(id_token) {
			// Sends Google token to server, where it can be verified and parsed
			return fetch('http://lvh.me:3000/api/login', {
				method: "POST", 
				mode: "cors",
				cache: "no-cache", 
				credentials: "same-origin",
				headers: {
			    	'Content-Type': 'application/json',
				},
				body: JSON.stringify({id_token}),
			})
			// Parses the response to json, or throws error
			.then(responseParser)
			// Sends token back to server, where it is parsed into user info
			.then(authenticatePageUser);
		}

		function authenticatePageUser(user) {
			console.log(user)
			return fetch('http://lvh.me:3000/api/users', {
				method: "POST",
				mode: "cors",
				cache: "no-cache", 
				credentials: "same-origin",
				headers: {
					'Content-Type': 'application/json',
					'authorization': 'Bearer ' + user.token
				},
			})
			.then(responseParser)
			.then(json => console.log(json));
		}
	</script>
</body>
</html>